<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="codewithssy">
<meta property="og:url" content="http://example.com/page/2/index.html">
<meta property="og:site_name" content="codewithssy">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="SUN Shiyu">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>codewithssy</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">codewithssy</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">SUN Shiyu的个人网站</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-schedule">

    <a href="/schedule/" rel="section"><i class="fa fa-calendar fa-fw"></i>日程表</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/01/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/09/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="SUN Shiyu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="codewithssy">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/01/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/09/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-04-01 21:13:27" itemprop="dateCreated datePublished" datetime="2022-04-01T21:13:27+08:00">2022-04-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-04-24 15:55:36" itemprop="dateModified" datetime="2022-04-24T15:55:36+08:00">2022-04-24</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="09操作系统的状态机模型"><a href="#09操作系统的状态机模型" class="headerlink" title="09操作系统的状态机模型"></a>09操作系统的状态机模型</h1><p>并发结束了，理解的方式：玩一玩示例代码</p>
<h2 id="CPU-reset"><a href="#CPU-reset" class="headerlink" title="CPU reset"></a>CPU reset</h2><p>minimal.S 最小的程序：不需要链接任何库</p>
<p>gcc编译，ld链接</p>
<p>初始CPU_state的规定：初始状态一定有一个PC</p>
<h3 id="CPU-reset行为"><a href="#CPU-reset行为" class="headerlink" title="CPU reset行为"></a>CPU reset行为</h3><p>registers的初值：唯一确定了处理器的状态，和手册完全一致</p>
<h2 id="Firmware固件"><a href="#Firmware固件" class="headerlink" title="Firmware固件"></a>Firmware固件</h2><ul>
<li>0xffff0向firmware跳转的jump指令</li>
</ul>
<p>CPU reset后执行的第一个程序</p>
<h3 id="BIOS-v-s-UEFI"><a href="#BIOS-v-s-UEFI" class="headerlink" title="BIOS v.s. UEFI"></a>BIOS v.s. UEFI</h3><p>确定启动磁盘，把前512bit的主引导扇区MBR 加载到物理内存的7c00位置</p>
<p>AB软盘、C磁盘</p>
<p>CPU reset后的代码执行？</p>
<h4 id="调试QEMU"><a href="#调试QEMU" class="headerlink" title="调试QEMU"></a>调试QEMU</h4><p>watchpoint监视点 在7c00处</p>
<p>QEMU：SeaBIOS firmware</p>
<p>ffmpeg视频转码：也是Fabrice Bellard的杰作</p>
<h2 id="操作系统的状态机模型"><a href="#操作系统的状态机模型" class="headerlink" title="操作系统的状态机模型"></a>操作系统的状态机模型</h2><h3 id="AbstractMachine-API含义理解"><a href="#AbstractMachine-API含义理解" class="headerlink" title="AbstractMachine API含义理解"></a>AbstractMachine API含义理解</h3><h4 id="TRM-MPE"><a href="#TRM-MPE" class="headerlink" title="TRM+MPE"></a>TRM+MPE</h4><h4 id="CTE"><a href="#CTE" class="headerlink" title="CTE"></a>CTE</h4><p>中断</p>
<p>context结构体</p>
<h4 id="VME"><a href="#VME" class="headerlink" title="VME"></a>VME</h4><p>虚拟内存</p>
<h3 id="RTFSC时间"><a href="#RTFSC时间" class="headerlink" title="RTFSC时间"></a>RTFSC时间</h3><h4 id="makefile阅读"><a href="#makefile阅读" class="headerlink" title="makefile阅读"></a>makefile阅读</h4>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/29/%E9%97%AE%E9%A2%98%E6%B1%82%E8%A7%A3/%E8%BF%91%E4%BC%BC%E7%AE%97%E6%B3%95%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="SUN Shiyu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="codewithssy">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/29/%E9%97%AE%E9%A2%98%E6%B1%82%E8%A7%A3/%E8%BF%91%E4%BC%BC%E7%AE%97%E6%B3%95%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/" class="post-title-link" itemprop="url">近似算法的基本概念</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-03-29 11:08:00" itemprop="dateCreated datePublished" datetime="2022-03-29T11:08:00+08:00">2022-03-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-03-30 23:25:49" itemprop="dateModified" datetime="2022-03-30T23:25:49+08:00">2022-03-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">课程笔记</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="近似算法的基本概念"><a href="#近似算法的基本概念" class="headerlink" title="近似算法的基本概念"></a>近似算法的基本概念</h1><h2 id="Concept-of-Approximation-Algorithms"><a href="#Concept-of-Approximation-Algorithms" class="headerlink" title="Concept of Approximation Algorithms"></a>Concept of Approximation Algorithms</h2><h3 id="fundamental-definition"><a href="#fundamental-definition" class="headerlink" title="fundamental definition"></a>fundamental definition</h3><p>优化问题的近似算法：</p>
<p>给出可行解的质量和最优解相差不太多</p>
<p>问题$U=(\Sigma_{I},\Sigma_{O},L,L_{I},M,cost,goal)$</p>
<h3 id="相对误差relative-error-varepsilon-A"><a href="#相对误差relative-error-varepsilon-A" class="headerlink" title="相对误差relative error $\varepsilon_{A}$"></a>相对误差relative error $\varepsilon_{A}$</h3><ul>
<li>$\varepsilon_{A}(x)=\frac{|cost(A(x))-Opt_{U}(x)}{Opt_{U}(x)}$</li>
</ul>
<p>对于特定输入x</p>
<ul>
<li><h3 id="varepsilon-A-n-max-varepsilon-A-x-in-L-I-cap-Sigma-I-n"><a href="#varepsilon-A-n-max-varepsilon-A-x-in-L-I-cap-Sigma-I-n" class="headerlink" title="$\varepsilon_{A}(n)=max{\varepsilon_{A}|x\in L_{I}\cap (\Sigma_{I})^{n}}$"></a>$\varepsilon_{A}(n)=max{\varepsilon_{A}|x\in L_{I}\cap (\Sigma_{I})^{n}}$</h3></li>
</ul>
<p>对于特定输入大小n，相对误差的最大值</p>
<h3 id="近似率the-approximation-ratio"><a href="#近似率the-approximation-ratio" class="headerlink" title="近似率the approximation ratio"></a>近似率the approximation ratio</h3><ul>
<li><h3 id="R-A-x-max-frac-cost-A-x-Opt-U-X-frac-Opt-U-x-cost-A-x"><a href="#R-A-x-max-frac-cost-A-x-Opt-U-X-frac-Opt-U-x-cost-A-x" class="headerlink" title="$R_{A}(x)=max{\frac{cost(A(x))}{Opt_{U}(X)},\frac{Opt_{U}(x)}{cost(A(x))}}$"></a>$R_{A}(x)=max{\frac{cost(A(x))}{Opt_{U}(X)},\frac{Opt_{U}(x)}{cost(A(x))}}$</h3></li>
<li><h3 id="R-A-n-max-R-A-x-x-in-L-I-cap-Sigma-I-n"><a href="#R-A-n-max-R-A-x-x-in-L-I-cap-Sigma-I-n" class="headerlink" title="$R_{A}(n)=max{R_{A}(x)|x\in L_{I}\cap (\Sigma_{I})^{n}}$"></a>$R_{A}(n)=max{R_{A}(x)|x\in L_{I}\cap (\Sigma_{I})^{n}}$</h3></li>
</ul>
<h3 id="var-approximation-algorithm"><a href="#var-approximation-algorithm" class="headerlink" title="$\var$-approximation algorithm"></a>$\var$-approximation algorithm</h3><ul>
<li>$R_{A}(x)\leq \var$</li>
</ul>
<h3 id="f-n-approximation-algorithm"><a href="#f-n-approximation-algorithm" class="headerlink" title="f(n)-approximation algorithm"></a>f(n)-approximation algorithm</h3><ul>
<li>$R_{A}(n)\leq f(n)$</li>
</ul>
<h3 id="Algorithm-4-2-1-3-GMS"><a href="#Algorithm-4-2-1-3-GMS" class="headerlink" title="Algorithm 4.2.1.3  GMS"></a>Algorithm 4.2.1.3  GMS</h3><h4 id="算法的基本过程"><a href="#算法的基本过程" class="headerlink" title="算法的基本过程"></a>算法的基本过程</h4><h5 id="step1："><a href="#step1：" class="headerlink" title="step1："></a>step1：</h5><p>降序排列$p_{i}$</p>
<h5 id="step2"><a href="#step2" class="headerlink" title="step2:"></a>step2:</h5><p>$T_{i}$: 第i个机器上的job序号集合</p>
<p>将最耗时的m个job先分配</p>
<p>初始化完成</p>
<h5 id="step3"><a href="#step3" class="headerlink" title="step3:"></a>step3:</h5><p>对于剩下的job，依次选择当前耗时最短的机器来执行，体现了贪心的策略</p>
<h5 id="step4："><a href="#step4：" class="headerlink" title="step4："></a>step4：</h5><p>输出结果</p>
<h4 id="为什么它是2-approximation-algorithm？"><a href="#为什么它是2-approximation-algorithm？" class="headerlink" title="为什么它是2-approximation algorithm？"></a>为什么它是2-approximation algorithm？</h4><p>首先，显然：<br>$Opt_{MS}(I)\geq p_{1}\geq p_{2}\dots\geq p_{n}$</p>
<p>同时，最优解一定还不小于平均工作时间：</p>
<p>$Opt_{MS}(I)\geq \frac{\sum\limits_{i=1}^{n}p_{i}}{m}$</p>
<p>同时，因为已经是降序排列的job，所以第k个工作不会大于之前的任何一个，所以一定不大于前k个工作的平均值：</p>
<p>$p_{k}\leq \frac{\sum\limits_{i=1}^{k}p_{i}}{k}$</p>
<p>下面对于n和m的大小进行分类讨论：</p>
<ol>
<li>$n\leq m$</li>
</ol>
<p>即工作数小于机器数，则解就是$p_{1}$的值，所以$\var=1$</p>
<ol start="2">
<li>$n&gt;m$</li>
</ol>
<p>工作数多于机器数，令$T_{l}$是GMS输出的序号集合，$k$是$T_{l}$中最大的序号</p>
<ul>
<li>$k\leq m$</li>
</ul>
<p>说明$T_{l}$中只有step2赋予的job，而这种情况下只可能是$p_{1}$</p>
<ul>
<li>$k&gt; m$</li>
</ul>
<p>因为$T_{l}$最后一次添加的job为$p_{k}$，所以在添加$p_{k}$之前，是所有机器里面耗时最短的，有</p>
<p>$Opt_{MS}(I)\geq \frac{\sum\limits_{i=1}^{n}p_{i}}{m}\geq \frac{\sum\limits_{i=1}^{k-1}p_{i}}{m}\geq cost(GMS(I))-p_{k}$</p>
<p>从右往左方便理解，观察后可以发现不等式中出现了相对误差</p>
<p>综合上面的不等式有：</p>
<p>$cost(GMS(I))-Opt_{MS}(I)\leq p_{k}\leq \frac{\sum\limits_{i=1}^{k}p_{i}}{k}$</p>
<p>$\frac{cost(GMS(I))-Opt_{MS}(I)}{Opt_{MS}(I)}\leq \frac{\frac{\sum\limits_{i=1}^{k}}{k}}{\frac{\sum\limits_{i=1}^{n}}{m}}\leq \frac{m}{k}&lt;1$</p>
<p>$cost(GMS(I))&lt;2*Opt_{MS}(I)$</p>
<p>即$\var &lt;2$</p>
<h3 id="Approximation-Schemes"><a href="#Approximation-Schemes" class="headerlink" title="Approximation Schemes"></a>Approximation Schemes</h3><p>对于任意的输入x，可以指定任意小的$\varepsilon$作为相对误差</p>
<h3 id="PTAS"><a href="#PTAS" class="headerlink" title="PTAS"></a>PTAS</h3><p>算法A满足：对于输入对$(x,\varepsilon)$可以在多项式时间内，得到可行解$A(x)$使得相对误差最大不超过$\varepsilon$，$Time_{A}(x,\varepsilon^{-1})$被限制在x的规模的多项式时间</p>
<h3 id="FPTAS"><a href="#FPTAS" class="headerlink" title="FPTAS"></a>FPTAS</h3><p>$Time_{A}(x,\varepsilon^{-1})$被限制在|x|和$\varepsilon^{-1}$的多项式时间函数</p>
<p>FPTAS可能是NP难优化问题最好的解</p>
<h2 id="NPO问题的分类"><a href="#NPO问题的分类" class="headerlink" title="NPO问题的分类"></a>NPO问题的分类</h2><p>从能找到的近似算法的效率来分类</p>
<h3 id="NPO-I"><a href="#NPO-I" class="headerlink" title="NPO(I)"></a>NPO(I)</h3><p>存在FPTAS算法</p>
<h3 id="NPO-II"><a href="#NPO-II" class="headerlink" title="NPO(II)"></a>NPO(II)</h3><p>有PTAS算法</p>
<h3 id="NPO-III"><a href="#NPO-III" class="headerlink" title="NPO(III)"></a>NPO(III)</h3><ul>
<li>存在$\delta$近似算法</li>
<li>$\delta$不能任意小</li>
</ul>
<h3 id="NPO-IV"><a href="#NPO-IV" class="headerlink" title="NPO(IV)"></a>NPO(IV)</h3><ul>
<li>存在$f(n)$近似算法，$f(n)$被多项式函数限制</li>
<li>不存在$\delta$近似算法</li>
</ul>
<h3 id="NPO-V"><a href="#NPO-V" class="headerlink" title="NPO(V)"></a>NPO(V)</h3><p>剩余的优化问题</p>
<p>$f(n)$增长非常的快</p>
<h2 id="Stability-稳定性"><a href="#Stability-稳定性" class="headerlink" title="Stability 稳定性"></a>Stability 稳定性</h2><h3 id="距离函数"><a href="#距离函数" class="headerlink" title="距离函数"></a>距离函数</h3><p>$h_{L}:L\rightarrow R^{\geq 0} $</p>
<ul>
<li>$h_{L}(x)=0,x\in L_{I}$</li>
<li>多项式时间可以计算</li>
</ul>
<h3 id="Ball-r-h-L-I"><a href="#Ball-r-h-L-I" class="headerlink" title="$Ball_{r,h}(L_{I})$"></a>$Ball_{r,h}(L_{I})$</h3><p>$L_{I}$输入实例扩充到距离不大于r的输入</p>
<p>$Ball_{r,h}(L_{I})={\omega \in L|h(\omega )\leq r}$</p>
<h3 id="p-stable-according-to-h"><a href="#p-stable-according-to-h" class="headerlink" title="p-stable according to h"></a>p-stable according to h</h3><p>A是$U_{r}$的$\delta_{r,\varepsilon}$近似算法，对于$0&lt;r\leq p$，$U_{r}$的输入实例扩展到了$Ball_{r,h}(L_I)$</p>
<h3 id="stable-according-to-h"><a href="#stable-according-to-h" class="headerlink" title="stable according to h"></a>stable according to h</h3><p>对于任意的p都是p-stable的</p>
<h3 id="r-f-r-n-quasistable-according-to-h"><a href="#r-f-r-n-quasistable-according-to-h" class="headerlink" title="$(r,f_{r}(n))-quasistable\ according\ to \ h$"></a>$(r,f_{r}(n))-quasistable\ according\ to \ h$</h3><p>A是$U_{r}$的$f_{r}(n)$近似算法，对于任意正整数r和函数$f_{r}:N\rightarrow R^{&gt;1}$</p>
<h3 id="以TSP问题为例来看距离函数的定义"><a href="#以TSP问题为例来看距离函数的定义" class="headerlink" title="以TSP问题为例来看距离函数的定义"></a>以TSP问题为例来看距离函数的定义</h3><p>定义$L_{\Delta}$: 边的权值满足三角不等式的输入实例</p>
<p>从三角不等式定义距离：</p>
<p>可以理解为距离满足三角不等式的输入的差距</p>
<p>有两种定义</p>
<p>$dist(G,c)=max{0,max{\frac{c({u,v})}{c({u,p}+c({p,v}))}-1|u,v,p\in V(G),u\neq v,v\neq p,v\neq p}}$</p>
<p>$dist_{k}(G,c)=max{0,max{\frac{c({u,v})}{\sum_{i=1}^{m}c({p_{i},p_{i+1}})}-1|u,v\in V(G) and u=p_{1},p_{2},\dots,p_{m}=v 是u和v之间的简单路径，长度不大于k}}$</p>
<p>对于$k\geq 2$</p>
<p>$dist(G,c)=max{dist(G,c)|2\leq k\leq |G|-1}$</p>
<h4 id="Ball-r-dist-L-Delta"><a href="#Ball-r-dist-L-Delta" class="headerlink" title="$Ball_{r,dist}(L_{\Delta})$"></a>$Ball_{r,dist}(L_{\Delta})$</h4><p>满足以下条件：</p>
<p>$\frac{c({u,v})}{c({u,p})+c({p,v})}-1\leq r$</p>
<h3 id="PTAS-的-stability"><a href="#PTAS-的-stability" class="headerlink" title="PTAS 的 stability"></a>PTAS 的 stability</h3>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/28/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/07/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="SUN Shiyu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="codewithssy">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/28/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/07/" class="post-title-link" itemprop="url">07真实世界的并发编程</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-03-28 16:46:00 / 修改时间：16:47:34" itemprop="dateCreated datePublished" datetime="2022-03-28T16:46:00+08:00">2022-03-28</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">课程笔记</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="07真实世界的并发编程"><a href="#07真实世界的并发编程" class="headerlink" title="07真实世界的并发编程"></a>07真实世界的并发编程</h1><h2 id="高性能并行计算"><a href="#高性能并行计算" class="headerlink" title="高性能并行计算"></a>高性能并行计算</h2><p>高性能计算机HPC</p>
<h3 id="主要挑战"><a href="#主要挑战" class="headerlink" title="主要挑战"></a>主要挑战</h3><p>计算任务如何分解</p>
<p>线程间如何通信 </p>
<h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><p>mandelbrot.c</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc mandelbrot.c -lpthread -lm -O2</span><br></pre></td></tr></table></figure>

<h3 id="viu-命令行工具"><a href="#viu-命令行工具" class="headerlink" title="viu 命令行工具"></a>viu 命令行工具</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">viu a.jpg</span><br></pre></td></tr></table></figure>

<h3 id="convert"><a href="#convert" class="headerlink" title="convert"></a>convert</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">convert a.pmm b.jpg</span><br></pre></td></tr></table></figure>

<p>.pmm为内置的图片格式</p>
<h2 id="数据中心和并发系统调用"><a href="#数据中心和并发系统调用" class="headerlink" title="数据中心和并发系统调用"></a>数据中心和并发系统调用</h2><h3 id="数据中心程序特点"><a href="#数据中心程序特点" class="headerlink" title="数据中心程序特点"></a>数据中心程序特点</h3><ul>
<li>以数据为中心</li>
<li>算法/系统对HPC和数据中心的意义<ul>
<li>实打实的成本的优化</li>
</ul>
</li>
</ul>
<h3 id="主要挑战-1"><a href="#主要挑战-1" class="headerlink" title="主要挑战"></a>主要挑战</h3><ul>
<li>一致性Consistency</li>
<li>Availability</li>
<li>容忍机器离线Partition tolerance</li>
</ul>
<h3 id="协程coroutines"><a href="#协程coroutines" class="headerlink" title="协程coroutines"></a>协程coroutines</h3><p>一个线程里只能有一个协程</p>
<p>开销小，但是会在系统调用上block</p>
<h4 id="Go和Goroutine"><a href="#Go和Goroutine" class="headerlink" title="Go和Goroutine"></a>Go和Goroutine</h4><h5 id="Goroutine"><a href="#Goroutine" class="headerlink" title="Goroutine"></a>Goroutine</h5><ul>
<li>每个 CPU 上有一个 Go Worker（线程），自由调度 goroutines（协程）</li>
<li>执行到 blocking API 时 (例如 sleep, read)<ul>
<li>Go Worker 偷偷改成 non-blocking 的版本<ul>
<li>成功 → 立即继续执行</li>
<li>失败 → 立即 yield 到另一个需要 CPU 的 goroutine</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1623121">如何在 Ubuntu 20.04 上安装 Go - 云+社区 - 腾讯云 (tencent.com)</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go run lib.go</span><br></pre></td></tr></table></figure>

<h3 id="生产者消费者API"><a href="#生产者消费者API" class="headerlink" title="生产者消费者API"></a>生产者消费者API</h3><p><a target="_blank" rel="noopener" href="http://jyywiki.cn/pages/OS/2022/demos/producer-consumer.go">http://jyywiki.cn/pages/OS/2022/demos/producer-consumer.go</a></p>
<ul>
<li>produce()</li>
<li>consume()</li>
</ul>
<h2 id="浏览器和异步编程"><a href="#浏览器和异步编程" class="headerlink" title="浏览器和异步编程"></a>浏览器和异步编程</h2><ul>
<li><p>HTML(DOM Tree)+CSS</p>
<ul>
<li>JavaScript</li>
<li>vscode就是一个浏览器</li>
</ul>
</li>
<li><p>单线程+事件模型</p>
<ul>
<li>事件队列按序执行</li>
</ul>
</li>
<li><p>异步事件模型</p>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/27/%E9%97%AE%E6%B1%82OJ/%E7%AC%AC%E5%9B%9B%E5%AD%A6%E6%9C%9F%E7%AC%AC4%E6%AC%A1%E4%BD%9C%E4%B8%9A04/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="SUN Shiyu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="codewithssy">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/27/%E9%97%AE%E6%B1%82OJ/%E7%AC%AC%E5%9B%9B%E5%AD%A6%E6%9C%9F%E7%AC%AC4%E6%AC%A1%E4%BD%9C%E4%B8%9A04/" class="post-title-link" itemprop="url">书上两点距离</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-03-27 21:14:00 / 修改时间：22:52:12" itemprop="dateCreated datePublished" datetime="2022-03-27T21:14:00+08:00">2022-03-27</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%AE%97%E6%B3%95%E9%A2%98%E8%A7%A3/" itemprop="url" rel="index"><span itemprop="name">算法题解</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="树上两点距离"><a href="#树上两点距离" class="headerlink" title="树上两点距离"></a>树上两点距离</h1><h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p><a target="_blank" rel="noopener" href="http://roundgod.com:8080/contest/116/problem/4">http://roundgod.com:8080/contest/116/problem/4</a></p>
<h2 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h2><p>LCA最近公共祖先</p>
<p>d[i][j]=d[fa[i][j-1]][j-1]+d[i][j-1]</p>
<p>或者</p>
<p>dist[x]+dist[y]-2*dist[lca(x,y)]</p>
<h2 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h2><h3 id="存边"><a href="#存边" class="headerlink" title="存边"></a>存边</h3><h4 id="邻接矩阵"><a href="#邻接矩阵" class="headerlink" title="邻接矩阵"></a>邻接矩阵</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// C++ Version</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n, m;</span><br><span class="line">vector&lt;<span class="type">bool</span>&gt; vis;</span><br><span class="line">vector&lt;vector&lt;<span class="type">bool</span>&gt; &gt; adj;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">find_edge</span><span class="params">(<span class="type">int</span> u, <span class="type">int</span> v)</span> </span>&#123; <span class="keyword">return</span> adj[u][v]; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">dfs</span><span class="params">(<span class="type">int</span> u)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (vis[u]) <span class="keyword">return</span>;</span><br><span class="line">  vis[u] = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> v = <span class="number">1</span>; v &lt;= n; ++v) &#123;</span><br><span class="line">    <span class="keyword">if</span> (adj[u][v]) &#123;</span><br><span class="line">      <span class="built_in">dfs</span>(v);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  cin &gt;&gt; n &gt;&gt; m;</span><br><span class="line"></span><br><span class="line">  vis.<span class="built_in">resize</span>(n + <span class="number">1</span>, <span class="literal">false</span>);</span><br><span class="line">  adj.<span class="built_in">resize</span>(n + <span class="number">1</span>, <span class="built_in">vector</span>&lt;<span class="type">bool</span>&gt;(n + <span class="number">1</span>, <span class="literal">false</span>));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= m; ++i) &#123;</span><br><span class="line">    <span class="type">int</span> u, v;</span><br><span class="line">    cin &gt;&gt; u &gt;&gt; v;</span><br><span class="line">    adj[u][v] = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="基于dist的实现"><a href="#基于dist的实现" class="headerlink" title="基于dist的实现"></a>基于dist的实现</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> MAX=<span class="number">500010</span>;</span><br><span class="line"><span class="type">int</span> ans[MAX];</span><br><span class="line"><span class="type">int</span> n,m;</span><br><span class="line">vector&lt;<span class="type">int</span>&gt; G[MAX];</span><br><span class="line">vector&lt;<span class="type">int</span>&gt; T[MAX];</span><br><span class="line"><span class="type">bool</span> vis[MAX];</span><br><span class="line"><span class="type">int</span> rt[MAX][<span class="number">22</span>];</span><br><span class="line"><span class="type">int</span> dep[MAX];</span><br><span class="line"><span class="type">int</span> dist[MAX];</span><br><span class="line"></span><br><span class="line">vector&lt;vector&lt;<span class="type">int</span>&gt; &gt; adj;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">dfs</span><span class="params">(<span class="type">int</span> r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> y: G[r])</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(!vis[y])</span><br><span class="line">        &#123;</span><br><span class="line">            T[r].<span class="built_in">push_back</span>(y);</span><br><span class="line">            vis[y]=<span class="number">1</span>;</span><br><span class="line">            dep[y]=dep[r]+<span class="number">1</span>;</span><br><span class="line">            rt[y][<span class="number">0</span>]=r;</span><br><span class="line">            dist[y]=dist[r]+adj[y][r];</span><br><span class="line">            <span class="built_in">dfs</span>(y); </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">query</span><span class="params">(<span class="type">int</span> x,<span class="type">int</span> y)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(dep[x]&gt;dep[y])</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">swap</span>(x,y);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">20</span>;i&gt;=<span class="number">0</span>;i--)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(dep[y]-(<span class="number">1</span>&lt;&lt;i)&gt;=dep[x])</span><br><span class="line">        &#123;</span><br><span class="line">            y=rt[y][i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(x==y)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">20</span>;i&gt;=<span class="number">0</span>;i--)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(rt[y][i]!=rt[x][i])</span><br><span class="line">        &#123;</span><br><span class="line">            y=rt[y][i];</span><br><span class="line">            x=rt[x][i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> rt[y][<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//存边</span></span><br><span class="line">    cin&gt;&gt;n&gt;&gt;m;</span><br><span class="line">    adj.<span class="built_in">resize</span>(n+<span class="number">1</span>,<span class="built_in">vector</span>&lt;<span class="type">int</span>&gt;(n+<span class="number">1</span>,<span class="number">0</span>));</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;n<span class="number">-1</span>;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> x,y,v;</span><br><span class="line">        cin&gt;&gt;x&gt;&gt;y&gt;&gt;v;</span><br><span class="line">        adj[x][y]=v;</span><br><span class="line">        adj[y][x]=v;</span><br><span class="line">    &#125;</span><br><span class="line">    dist[<span class="number">1</span>]=<span class="number">0</span>;</span><br><span class="line">    vis[<span class="number">1</span>]=<span class="number">1</span>;</span><br><span class="line">    dep[<span class="number">1</span>]=<span class="number">1</span>;</span><br><span class="line">    <span class="built_in">dfs</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">1</span>;j&lt;=<span class="number">20</span>;j++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=n;i++)</span><br><span class="line">        &#123;</span><br><span class="line">            rt[i][j]=rt[rt[i][j<span class="number">-1</span>]][j<span class="number">-1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;m;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> x,y,z;</span><br><span class="line">        cin&gt;&gt;x&gt;&gt;y;</span><br><span class="line">        z=<span class="built_in">query</span>(x,y);</span><br><span class="line">        ans[i]=dist[x]+dist[y]<span class="number">-2</span>*dist[z];        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;m;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        cout&lt;&lt;ans[i]&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是有问题，还未解决</p>
<h2 id="AC代码"><a href="#AC代码" class="headerlink" title="AC代码"></a>AC代码</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cmath&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX 200005</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAXDepth 20 </span></span><br><span class="line"><span class="type">int</span> n = <span class="number">0</span>, m = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> tot = <span class="number">0</span>, Last[MAX] = &#123;<span class="number">0</span>&#125;, Next[MAX] = &#123;<span class="number">0</span>&#125;, End[MAX] = &#123;<span class="number">0</span>&#125;, len[MAX] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="type">int</span> fa[MAX][MAXDepth] = &#123;<span class="number">0</span>&#125;, val[MAX][MAXDepth] = &#123;<span class="number">0</span>&#125;, Depth[MAX] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="type">int</span> Visited[MAX] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Add</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y, <span class="type">int</span> z)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	tot++;</span><br><span class="line">	End[tot] = y;</span><br><span class="line">	len[tot] = z;</span><br><span class="line">	Next[tot] = Last[x];</span><br><span class="line">	Last[x] = tot;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DFS</span><span class="params">(<span class="type">int</span> x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Visited[x] = <span class="number">1</span>;</span><br><span class="line">	<span class="type">int</span> t = <span class="number">0</span>, k = <span class="number">0</span>, y = <span class="number">0</span>;</span><br><span class="line">	Depth[x] = Depth[fa[x][<span class="number">0</span>]] + <span class="number">1</span>;</span><br><span class="line">	k = <span class="built_in">ceil</span>(<span class="built_in">log</span>((<span class="type">double</span>)Depth[x])/<span class="built_in">log</span>(<span class="number">2.0</span>));</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt;= k; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		fa[x][i] = fa[fa[x][i - <span class="number">1</span>]][i - <span class="number">1</span>];	</span><br><span class="line">		val[x][i] = val[x][i - <span class="number">1</span>] + val[fa[x][i - <span class="number">1</span>]][i - <span class="number">1</span>];</span><br><span class="line">	&#125;</span><br><span class="line">	t = Last[x];</span><br><span class="line">	<span class="keyword">while</span>(t &gt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		y = End[t];</span><br><span class="line">		<span class="keyword">if</span>(Visited[y] == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			fa[y][<span class="number">0</span>] = x;</span><br><span class="line">			val[y][<span class="number">0</span>] = len[t];</span><br><span class="line">		  <span class="built_in">DFS</span>(y);</span><br><span class="line">		&#125;</span><br><span class="line">		t = Next[t];</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">LCA</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> k = <span class="number">0</span>, diff = <span class="number">0</span>, ans = <span class="number">0</span>;</span><br><span class="line">	k = <span class="built_in">ceil</span>(<span class="built_in">log</span>((<span class="type">double</span>)n)/<span class="built_in">log</span>(<span class="number">2.0</span>));</span><br><span class="line">	<span class="keyword">if</span>(Depth[x] &lt; Depth[y])<span class="built_in">swap</span>(x, y);</span><br><span class="line">	</span><br><span class="line">	diff = Depth[x] - Depth[y];</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt;= k; i++)</span><br><span class="line">		<span class="keyword">if</span>(diff &amp; (<span class="number">1</span> &lt;&lt; i))</span><br><span class="line">		&#123;</span><br><span class="line">			ans += val[x][i];</span><br><span class="line">			x = fa[x][i];</span><br><span class="line">		&#125;</span><br><span class="line">	<span class="keyword">if</span>(x == y)<span class="keyword">return</span> ans;</span><br><span class="line"></span><br><span class="line">	k = <span class="built_in">ceil</span>(<span class="built_in">log</span>((<span class="type">double</span>)Depth[x])/<span class="built_in">log</span>(<span class="number">2.0</span>));</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i = k; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">		<span class="keyword">if</span>(fa[x][i] != fa[y][i])</span><br><span class="line">		&#123;</span><br><span class="line">			ans += val[x][i];</span><br><span class="line">			ans += val[y][i];</span><br><span class="line">			x = fa[x][i];</span><br><span class="line">			y = fa[y][i];</span><br><span class="line">		&#125;</span><br><span class="line">	ans += val[x][<span class="number">0</span>];</span><br><span class="line">	ans += val[y][<span class="number">0</span>];</span><br><span class="line">	<span class="keyword">return</span> ans;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> x, y, z;</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">&quot;%d%d&quot;</span>, &amp;n, &amp;m);</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt; n; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">scanf</span>(<span class="string">&quot;%d%d%d&quot;</span>, &amp;x, &amp;y, &amp;z);</span><br><span class="line">		<span class="built_in">Add</span>(x, y, z);</span><br><span class="line">		<span class="built_in">Add</span>(y, x, z);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">DFS</span>(<span class="number">1</span>);</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt;= m; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">scanf</span>(<span class="string">&quot;%d%d&quot;</span>, &amp;x, &amp;y);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, <span class="built_in">LCA</span>(x, y));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="基于dist、Tarjan算法的AC代码"><a href="#基于dist、Tarjan算法的AC代码" class="headerlink" title="基于dist、Tarjan算法的AC代码"></a>基于dist、Tarjan算法的AC代码</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*使用DFS求点到根的距离，之后跑一遍LCA，用询问两点的距离和减去LCA距离的两倍就得到最短路*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;math.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> maxn 100005</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> maxm 100005</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="type">int</span> n, m;</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> visited[maxn];</span><br><span class="line"><span class="type">int</span> first_edge[maxn], first_query[maxn], pre[maxn];</span><br><span class="line"><span class="type">int</span> ans[maxm];</span><br><span class="line"><span class="type">int</span> dist[maxn];</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Edge</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> u, v, next, w;</span><br><span class="line">&#125; E[<span class="number">2</span> * maxn];</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Query</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> s, t, next, id;</span><br><span class="line">&#125; Q[<span class="number">2</span> * maxm];</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> cnt, cntq;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">add</span><span class="params">(<span class="type">int</span> u, <span class="type">int</span> v, <span class="type">int</span> w)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	E[++cnt].u = u;</span><br><span class="line">	E[cnt].v = v;</span><br><span class="line">	E[cnt].w = w;</span><br><span class="line">	E[cnt].next = first_edge[u];</span><br><span class="line">	first_edge[u] = cnt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">addq</span><span class="params">(<span class="type">int</span> s, <span class="type">int</span> t, <span class="type">int</span> id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Q[++cntq].s = s;</span><br><span class="line">	Q[cntq].t = t;</span><br><span class="line">	Q[cntq].id = id;</span><br><span class="line">	Q[cntq].next = first_query[s];</span><br><span class="line">	first_query[s] = cntq;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 并查集查找</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">find</span><span class="params">(<span class="type">int</span> x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> x == pre[x] ? x : pre[x] = <span class="built_in">find</span>(pre[x]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Tarjan</span><span class="params">(<span class="type">int</span> u)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	pre[u] = u;</span><br><span class="line">	visited[u] = <span class="literal">true</span>;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = first_edge[u]; i; i = E[i].next) &#123;</span><br><span class="line">		<span class="type">int</span> v = E[i].v;</span><br><span class="line">		<span class="keyword">if</span> (!visited[v]) &#123;</span><br><span class="line">			dist[v] = dist[u] + E[i].w;</span><br><span class="line">			<span class="built_in">Tarjan</span>(v);</span><br><span class="line">			pre[v] = u;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = first_query[u]; i; i = Q[i].next) &#123;</span><br><span class="line">		<span class="type">int</span> t = Q[i].t;</span><br><span class="line">		<span class="keyword">if</span> (!visited[t]) <span class="keyword">continue</span>;</span><br><span class="line">		ans[Q[i].id] = <span class="built_in">find</span>(t);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	cin &gt;&gt; n &gt;&gt; m;	<span class="comment">// 树的结点个数、询问的个数和树根结点的序号</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>, x, y, w; i &lt; n - <span class="number">1</span>; i++) &#123;</span><br><span class="line">		cin &gt;&gt; x &gt;&gt; y &gt;&gt; w;</span><br><span class="line">		<span class="built_in">add</span>(x, y, w);</span><br><span class="line">		<span class="built_in">add</span>(y, x, w);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>, a, b; i &lt; m; i++) &#123;</span><br><span class="line">		cin &gt;&gt; a &gt;&gt; b;</span><br><span class="line">		<span class="built_in">addq</span>(a, b, i);</span><br><span class="line">		<span class="built_in">addq</span>(b, a, i);</span><br><span class="line">	&#125;</span><br><span class="line">	dist[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">	<span class="built_in">Tarjan</span>(<span class="number">1</span>);</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; m; i++) &#123;</span><br><span class="line">		<span class="type">int</span> q = <span class="number">2</span> * i + <span class="number">1</span>;</span><br><span class="line">		cout &lt;&lt; dist[Q[q].s] + dist[Q[q].t] - <span class="number">2</span> * dist[ans[i]] &lt;&lt; endl;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/27/%E9%97%AE%E6%B1%82OJ/%E7%AC%AC%E5%9B%9B%E5%AD%A6%E6%9C%9F%E7%AC%AC4%E6%AC%A1%E4%BD%9C%E4%B8%9A03/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="SUN Shiyu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="codewithssy">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/27/%E9%97%AE%E6%B1%82OJ/%E7%AC%AC%E5%9B%9B%E5%AD%A6%E6%9C%9F%E7%AC%AC4%E6%AC%A1%E4%BD%9C%E4%B8%9A03/" class="post-title-link" itemprop="url">最近公共祖先</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-03-27 20:07:00 / 修改时间：21:13:53" itemprop="dateCreated datePublished" datetime="2022-03-27T20:07:00+08:00">2022-03-27</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%AE%97%E6%B3%95%E9%A2%98%E8%A7%A3/" itemprop="url" rel="index"><span itemprop="name">算法题解</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="最近公共祖先"><a href="#最近公共祖先" class="headerlink" title="最近公共祖先"></a>最近公共祖先</h1><h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p><a target="_blank" rel="noopener" href="http://roundgod.com:8080/contest/116/problem/3">http://roundgod.com:8080/contest/116/problem/3</a></p>
<p>给定一棵有根树，请求出指定两个点直接最近的公共祖先。</p>
<h2 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">graph TB</span><br><span class="line"></span><br><span class="line">1((1))</span><br><span class="line">2((2))</span><br><span class="line">3((3))</span><br><span class="line">4((4))</span><br><span class="line">5((5))</span><br><span class="line"></span><br><span class="line">4--&gt;2</span><br><span class="line">1--&gt;3</span><br><span class="line">1--&gt;5</span><br><span class="line">4--&gt;1</span><br></pre></td></tr></table></figure>

<h3 id="样例"><a href="#样例" class="headerlink" title="样例"></a>样例</h3><h4 id="样例输入1"><a href="#样例输入1" class="headerlink" title="样例输入1"></a><strong>样例输入1</strong></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">5 5 4</span><br><span class="line">3 1</span><br><span class="line">2 4</span><br><span class="line">5 1</span><br><span class="line">1 4</span><br><span class="line"></span><br><span class="line">2 4</span><br><span class="line">3 2</span><br><span class="line">3 5</span><br><span class="line">1 2</span><br><span class="line">4 5</span><br></pre></td></tr></table></figure>

<h4 id="样例输出1"><a href="#样例输出1" class="headerlink" title="样例输出1"></a><strong>样例输出1</strong></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">4</span><br><span class="line">4</span><br><span class="line">1</span><br><span class="line">4</span><br><span class="line">4</span><br></pre></td></tr></table></figure>

<h3 id="倍增算法"><a href="#倍增算法" class="headerlink" title="倍增算法"></a>倍增算法</h3><p>fa[i][j]</p>
<p>i节点向上走2^j步对应的节点</p>
<p>fa[i][j]=fa[fa[i][j-1]][j-1]</p>
<p>先走2^j-1,再走2^j-1</p>
<p>读入x，y</p>
<p>dep[x],dep[y]记录深度</p>
<p>5=101</p>
<p>先拉平深度</p>
<h2 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h2><h2 id="AC代码"><a href="#AC代码" class="headerlink" title="AC代码"></a>AC代码</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> MAX=<span class="number">500010</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n,m,s;</span><br><span class="line">vector&lt;<span class="type">int</span>&gt; G[MAX];</span><br><span class="line">vector&lt;<span class="type">int</span>&gt; T[MAX];</span><br><span class="line"><span class="type">bool</span> vis[MAX];</span><br><span class="line"><span class="type">int</span> rt[MAX][<span class="number">22</span>];</span><br><span class="line"><span class="type">int</span> dep[MAX];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">dfs</span><span class="params">(<span class="type">int</span> r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> y: G[r])</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(!vis[y])</span><br><span class="line">        &#123;</span><br><span class="line">            T[r].<span class="built_in">push_back</span>(y);</span><br><span class="line">            vis[y]=<span class="number">1</span>;</span><br><span class="line">            dep[y]=dep[r]+<span class="number">1</span>;</span><br><span class="line">            rt[y][<span class="number">0</span>]=r;</span><br><span class="line">            <span class="built_in">dfs</span>(y); </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">query</span><span class="params">(<span class="type">int</span> x,<span class="type">int</span> y)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(dep[x]&gt;dep[y])</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">swap</span>(x,y);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">20</span>;i&gt;=<span class="number">0</span>;i--)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(dep[y]-(<span class="number">1</span>&lt;&lt;i)&gt;=dep[x])</span><br><span class="line">        &#123;</span><br><span class="line">            y=rt[y][i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(x==y)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">20</span>;i&gt;=<span class="number">0</span>;i--)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(rt[y][i]!=rt[x][i])</span><br><span class="line">        &#123;</span><br><span class="line">            y=rt[y][i];</span><br><span class="line">            x=rt[x][i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> rt[y][<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    cin&gt;&gt;n&gt;&gt;m&gt;&gt;s;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;n<span class="number">-1</span>;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> x,y;</span><br><span class="line">        cin&gt;&gt;x&gt;&gt;y;</span><br><span class="line">        G[x].<span class="built_in">push_back</span>(y);</span><br><span class="line">        G[y].<span class="built_in">push_back</span>(x);</span><br><span class="line">    &#125;</span><br><span class="line">    vis[s]=<span class="number">1</span>;</span><br><span class="line">    dep[s]=<span class="number">1</span>;</span><br><span class="line">    <span class="built_in">dfs</span>(s);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">1</span>;j&lt;=<span class="number">20</span>;j++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=n;i++)</span><br><span class="line">        &#123;</span><br><span class="line">            rt[i][j]=rt[rt[i][j<span class="number">-1</span>]][j<span class="number">-1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;m;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> x,y;</span><br><span class="line">        cin&gt;&gt;x&gt;&gt;y;</span><br><span class="line">        cout&lt;&lt;<span class="built_in">query</span>(x,y)&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/27/%E9%97%AE%E6%B1%82OJ/%E7%AC%AC%E5%9B%9B%E5%AD%A6%E6%9C%9F%E7%AC%AC4%E6%AC%A1%E4%BD%9C%E4%B8%9A02/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="SUN Shiyu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="codewithssy">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/27/%E9%97%AE%E6%B1%82OJ/%E7%AC%AC%E5%9B%9B%E5%AD%A6%E6%9C%9F%E7%AC%AC4%E6%AC%A1%E4%BD%9C%E4%B8%9A02/" class="post-title-link" itemprop="url">点共线问题</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-03-27 11:05:00 / 修改时间：20:06:04" itemprop="dateCreated datePublished" datetime="2022-03-27T11:05:00+08:00">2022-03-27</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%AE%97%E6%B3%95%E9%A2%98%E8%A7%A3/" itemprop="url" rel="index"><span itemprop="name">算法题解</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="点共线问题"><a href="#点共线问题" class="headerlink" title="点共线问题"></a>点共线问题</h1><h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p><a target="_blank" rel="noopener" href="http://roundgod.com:8080/contest/116/problem/2">http://roundgod.com:8080/contest/116/problem/2</a></p>
<h2 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h2><p>数据范围只到1000：</p>
<p>枚举法</p>
<p>确定直线上的一点</p>
<p>(x,y) (x,y2) 斜率无穷大</p>
<p>(x,y)  (x1,y1)</p>
<p>map(dx,dy)  二元组可以代表斜率的大小</p>
<p>gcd</p>
<h2 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h2><h3 id="map"><a href="#map" class="headerlink" title="map"></a>map</h3><h4 id="需要导入头文件"><a href="#需要导入头文件" class="headerlink" title="需要导入头文件"></a>需要导入头文件</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;map&gt;</span> <span class="comment">// STL头文件没有扩展名.h</span></span></span><br></pre></td></tr></table></figure>

<h4 id="map-对象是一个模版类，需要关键字和存储对象两个模版参数"><a href="#map-对象是一个模版类，需要关键字和存储对象两个模版参数" class="headerlink" title="map 对象是一个模版类，需要关键字和存储对象两个模版参数"></a>map 对象是一个模版类，需要关键字和存储对象两个模版参数</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">std::map&lt;<span class="type">int</span> , std::string&gt; person;</span><br></pre></td></tr></table></figure>

<p>在该题目中的使用</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">map&lt;rec,<span class="type">int</span>&gt; mp;</span><br></pre></td></tr></table></figure>

<p>其中rec是自行定义的结构体</p>
<h4 id="mp-clear"><a href="#mp-clear" class="headerlink" title="mp.clear()"></a>mp.clear()</h4><p>删除所有元素</p>
<h3 id="struct结构体"><a href="#struct结构体" class="headerlink" title="struct结构体"></a>struct结构体</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">rec</span>&#123;</span><br><span class="line">    ll dx;</span><br><span class="line">    ll dy;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">rec</span>(ll dx, ll dy): <span class="built_in">dx</span>(dx), <span class="built_in">dy</span>(dy)&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> <span class="keyword">operator</span>&lt;(<span class="type">const</span> rec&amp; rhs) <span class="type">const</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> dx&lt; rhs.dx || (dx== rhs.dx &amp;&amp; dy &lt; rhs.dy);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="结构体构造函数"><a href="#结构体构造函数" class="headerlink" title="结构体构造函数"></a>结构体构造函数</h4><h5 id="有参构造"><a href="#有参构造" class="headerlink" title="有参构造"></a>有参构造</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rec(ll dx,ll dy): dx(dx), dy(dy)&#123;&#125;</span><br></pre></td></tr></table></figure>



<h3 id="gcd-函数"><a href="#gcd-函数" class="headerlink" title="gcd()函数"></a>gcd()函数</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ll <span class="title">gcd</span><span class="params">(ll x,ll y)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> y ? <span class="built_in">gcd</span>(y,x%y):x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用的是辗转相除法</p>
<h3 id="abs"><a href="#abs" class="headerlink" title="abs()"></a>abs()</h3><h2 id="OJ结果"><a href="#OJ结果" class="headerlink" title="OJ结果"></a>OJ结果</h2><p>测试样例正确，但部分结果错误</p>
<h2 id="未AC代码"><a href="#未AC代码" class="headerlink" title="未AC代码"></a>未AC代码</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;map&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">long</span> ll;</span><br><span class="line"><span class="type">const</span> ll MAX = <span class="number">1010</span>;</span><br><span class="line">ll n;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">rec</span>&#123;</span><br><span class="line">    ll dx;</span><br><span class="line">    ll dy;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">rec</span>(ll dx, ll dy): <span class="built_in">dx</span>(dx), <span class="built_in">dy</span>(dy)&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> <span class="keyword">operator</span>&lt;(<span class="type">const</span> rec&amp; rhs) <span class="type">const</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> dx&lt; rhs.dx || (dx== rhs.dx &amp;&amp; dy &lt; rhs.dy);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">ll X[MAX];</span><br><span class="line">ll Y[MAX];</span><br><span class="line"></span><br><span class="line">map&lt;rec,<span class="type">int</span>&gt; mp;</span><br><span class="line"></span><br><span class="line"><span class="function">ll <span class="title">gcd</span><span class="params">(ll x,ll y)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> y ? <span class="built_in">gcd</span>(y,x%y):x;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    cin&gt;&gt;n;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;n;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        cin&gt;&gt;X[i]&gt;&gt;Y[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> ans=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;n;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        mp.<span class="built_in">clear</span>();</span><br><span class="line">        <span class="type">int</span> dcnt=<span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> mlcnt=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;n;j++)</span><br><span class="line">        &#123;</span><br><span class="line">            ll dx=X[j]-X[i];</span><br><span class="line">            ll dy=Y[j]-Y[i];</span><br><span class="line">            <span class="keyword">if</span>(dx==<span class="number">0</span> &amp;&amp; dy==<span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                dcnt++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(dy==<span class="number">0</span> )<span class="comment">//横线</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//都存到mp[rec(1,0)]中</span></span><br><span class="line">                mlcnt= <span class="built_in">max</span>(mlcnt,++mp[<span class="built_in">rec</span>(<span class="number">1</span>,<span class="number">0</span>)]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(dx==<span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                mlcnt=<span class="built_in">max</span>(mlcnt,++mp[<span class="built_in">rec</span>(<span class="number">0</span>,<span class="number">1</span>)]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="type">bool</span> m=(dx&lt;<span class="number">0</span>);</span><br><span class="line">                <span class="comment">//绝对值</span></span><br><span class="line">                dy=<span class="built_in">abs</span>(dy);</span><br><span class="line">                dx=<span class="built_in">abs</span>(dx);</span><br><span class="line">                ll g=<span class="built_in">gcd</span>(dx,dy);</span><br><span class="line">                dx=dx/g;dy=dy/g;</span><br><span class="line">                <span class="keyword">if</span>(m) dx=-dx;</span><br><span class="line">                mlcnt=<span class="built_in">max</span>(mlcnt,++mp[<span class="built_in">rec</span>(dx,dy)]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ans=<span class="built_in">max</span>(ans,mlcnt+dcnt);</span><br><span class="line">    &#125;</span><br><span class="line">    cout&lt;&lt;ans&lt;&lt;endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="AC代码"><a href="#AC代码" class="headerlink" title="AC代码"></a>AC代码</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> maxn=<span class="number">1005</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">point</span> &#123;</span><br><span class="line">	<span class="type">int</span> x;<span class="type">int</span> y;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">gcd</span><span class="params">(<span class="type">int</span> x,<span class="type">int</span> y)</span> </span>&#123; </span><br><span class="line">        <span class="keyword">if</span> (y == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> x;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span>  <span class="built_in">gcd</span>(y, x%y);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   point m[maxn];</span><br><span class="line">   <span class="type">int</span> n;</span><br><span class="line">   cin&gt;&gt;n;</span><br><span class="line">   <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;n;i++)</span><br><span class="line">   &#123;</span><br><span class="line">   	cin&gt;&gt;m[i].x&gt;&gt;m[i].y;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span>(n==<span class="number">0</span>)cout&lt;&lt;<span class="number">0</span>;</span><br><span class="line">   <span class="keyword">if</span>(n==<span class="number">1</span>)cout&lt;&lt;<span class="number">1</span>;</span><br><span class="line">   <span class="keyword">if</span>(n==<span class="number">2</span>)cout&lt;&lt;<span class="number">2</span>;</span><br><span class="line">   <span class="keyword">if</span>(n&gt;<span class="number">2</span>)</span><br><span class="line">   &#123;</span><br><span class="line">   	<span class="type">int</span> ans=<span class="number">0</span>;</span><br><span class="line">   	<span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;n;i++)</span><br><span class="line">   	&#123;</span><br><span class="line">   		 map&lt;pair&lt;<span class="type">int</span>, <span class="type">int</span>&gt;, <span class="type">int</span>&gt; c;</span><br><span class="line">   	<span class="type">int</span> cover=<span class="number">0</span>,verti=<span class="number">0</span>,maxk=<span class="number">0</span>;</span><br><span class="line">    <span class="comment">//注意i+1</span></span><br><span class="line">   	<span class="keyword">for</span>(<span class="type">int</span> j=i+<span class="number">1</span>;j&lt;n;j++)</span><br><span class="line">   	&#123;</span><br><span class="line">   		<span class="type">int</span> dx=m[i].x-m[j].x;</span><br><span class="line">   		<span class="type">int</span> dy=m[i].y-m[j].y;</span><br><span class="line">   		<span class="keyword">if</span>(dx==<span class="number">0</span>&amp;&amp;dy==<span class="number">0</span>)cover++;</span><br><span class="line">   		<span class="keyword">else</span> <span class="keyword">if</span>(dx ==<span class="number">0</span>)verti++;</span><br><span class="line">   		<span class="keyword">else</span></span><br><span class="line">   		&#123;</span><br><span class="line">            <span class="comment">//b</span></span><br><span class="line">   			<span class="type">int</span> g=<span class="built_in">gcd</span>(dx,dy);</span><br><span class="line">   			dx/=g;dy/=g;</span><br><span class="line">   			maxk=<span class="built_in">max</span>(maxk,++c[<span class="built_in">make_pair</span>(dx,dy)]);</span><br><span class="line">   		&#125;</span><br><span class="line">   	&#125;</span><br><span class="line">   	maxk=<span class="built_in">max</span>(maxk,verti);</span><br><span class="line">   	ans = <span class="built_in">max</span>(ans, maxk + cover +<span class="number">1</span>);</span><br><span class="line">   	&#125;</span><br><span class="line">   	cout&lt;&lt;ans;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/24/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/06/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="SUN Shiyu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="codewithssy">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/24/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/06/" class="post-title-link" itemprop="url">OS06并发控制：同步</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-03-24 11:38:00" itemprop="dateCreated datePublished" datetime="2022-03-24T11:38:00+08:00">2022-03-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-04-01 22:56:16" itemprop="dateModified" datetime="2022-04-01T22:56:16+08:00">2022-04-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">课程笔记</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="06并发控制：同步"><a href="#06并发控制：同步" class="headerlink" title="06并发控制：同步"></a>06并发控制：同步</h1><h2 id="线程同步"><a href="#线程同步" class="headerlink" title="线程同步"></a>线程同步</h2><p>在某个时间点共同达到互相已知的状态</p>
<p>重点解决生产者-消费者问题</p>
<h2 id="生产者-消费者问题"><a href="#生产者-消费者问题" class="headerlink" title="生产者-消费者问题"></a>生产者-消费者问题</h2><p>要求满足括号配对规则:</p>
<ul>
<li>右括号与左括号对应，合法的括号序列的前缀</li>
<li>嵌套深度不超过参数n</li>
<li>问题中的同步<ul>
<li>有空位打印左括号</li>
<li>能配对才打印右括号</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">Tproduce</span><span class="params">()</span> &#123; <span class="keyword">while</span> (<span class="number">1</span>) <span class="built_in">printf</span>(<span class="string">&quot;(&quot;</span>); &#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Tconsume</span><span class="params">()</span> &#123; <span class="keyword">while</span> (<span class="number">1</span>) <span class="built_in">printf</span>(<span class="string">&quot;)&quot;</span>); &#125;</span><br></pre></td></tr></table></figure>

<p>左括号：生产者：生产资源（任务），放入队列</p>
<p>右括号：消费者：取出任务执行</p>
<p>在实际应用中，牵涉到任务划分为子任务，等待空闲的线程执行子任务</p>
<h3 id="代码实现-pc-c"><a href="#代码实现-pc-c" class="headerlink" title="代码实现 pc.c"></a>代码实现 pc.c</h3><p>用互斥锁保持条件成立</p>
<p>count 记录当前资源量</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Tproduce</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line"></span><br><span class="line">retry:</span><br><span class="line">    <span class="built_in">mutex_lock</span>(&amp;lk);<span class="comment">//读全局变量的值就上锁</span></span><br><span class="line">      </span><br><span class="line">    <span class="keyword">if</span> (count == n) &#123;</span><br><span class="line">      <span class="built_in">mutex_unlock</span>(&amp;lk);<span class="comment">//解锁1</span></span><br><span class="line">      <span class="keyword">goto</span> retry;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    count++;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;(&quot;</span>);</span><br><span class="line">    <span class="built_in">mutex_unlock</span>(&amp;lk);<span class="comment">//解锁2</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Tconsume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">retry:</span><br><span class="line">    <span class="built_in">mutex_lock</span>(&amp;lk);</span><br><span class="line">    <span class="keyword">if</span> (count == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">mutex_unlock</span>(&amp;lk);</span><br><span class="line">      <span class="keyword">goto</span> retry;</span><br><span class="line">    &#125;</span><br><span class="line">    count--;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;)&quot;</span>);</span><br><span class="line">    <span class="built_in">mutex_unlock</span>(&amp;lk);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="压力测试的检查"><a href="#压力测试的检查" class="headerlink" title="压力测试的检查"></a>压力测试的检查</h4><p>pc-check.py</p>
<p>判断条件：$0\leq count\leq n$</p>
<p>会一门脚本语言的重要性</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./a.out n | python3 pc-check.py n</span><br></pre></td></tr></table></figure>

<h2 id="条件变量"><a href="#条件变量" class="headerlink" title="条件变量"></a>条件变量</h2><p>把 <a target="_blank" rel="noopener" href="http://jyywiki.cn/pages/OS/2022/demos/pc.c">pc.c</a> 中的自旋变成睡眠，在完成操作时唤醒 </p>
<h3 id="条件变量API"><a href="#条件变量API" class="headerlink" title="条件变量API"></a>条件变量API</h3><h4 id="wait-cv-mutex"><a href="#wait-cv-mutex" class="headerlink" title="wait(cv,mutex)"></a>wait(cv,mutex)</h4><ul>
<li>获得mutex后调用</li>
<li>释放mutex，进入睡眠状态</li>
</ul>
<h4 id="signal-notify-cv"><a href="#signal-notify-cv" class="headerlink" title="signal/notify(cv)"></a>signal/notify(cv)</h4><ul>
<li>唤醒等待cv的其中一个线程</li>
</ul>
<h4 id="broadcast-notifyAll-cv"><a href="#broadcast-notifyAll-cv" class="headerlink" title="broadcast/notifyAll(cv)"></a>broadcast/notifyAll(cv)</h4><ul>
<li>唤醒所有在等待cv的线程</li>
</ul>
<h3 id="实现生产者消费者问题"><a href="#实现生产者消费者问题" class="headerlink" title="实现生产者消费者问题"></a>实现生产者消费者问题</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">Tproduce</span><span class="params">()</span> &#123;</span><br><span class="line">  mutex_lock(&amp;lk);</span><br><span class="line">  <span class="keyword">if</span> (!(count != n)) </span><br><span class="line">  	cond_wait(&amp;cv, &amp;lk);<span class="comment">//释放lk进入等待状态</span></span><br><span class="line">    </span><br><span class="line">  <span class="comment">//(count!=n)条件满足继续执行</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;(&quot;</span>); </span><br><span class="line">  count++; </span><br><span class="line">  cond_signal(&amp;cv);<span class="comment">//唤醒在等待状态的一个线程</span></span><br><span class="line">  mutex_unlock(&amp;lk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">Tconsume</span><span class="params">()</span> &#123;</span><br><span class="line">  mutex_lock(&amp;lk);</span><br><span class="line">  <span class="keyword">if</span> (!(count != <span class="number">0</span>)) </span><br><span class="line">    cond_wait(&amp;cv, &amp;lk);</span><br><span class="line">  <span class="comment">//(count!=0)条件满足继续执行</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;)&quot;</span>); </span><br><span class="line">  count--;</span><br><span class="line">  cond_signal(&amp;cv);</span><br><span class="line">  mutex_unlock(&amp;lk);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>打印前512个输出</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./a.out 1 | head -c 512</span><br></pre></td></tr></table></figure>

<p>发现出现问题</p>
<p>需要修改</p>
<p>需要while（1）死循环</p>
<p>修改过后实现了正确的代码</p>
<h4 id="问题所在"><a href="#问题所在" class="headerlink" title="问题所在"></a>问题所在</h4><p>只有一个生产者和消费者的情况是可以的，但如果有多个生产者或消费者则会出现问题</p>
<p>consumer唤醒了另一个consumer</p>
<p>要求producer只能唤醒consumer，consumer只能唤醒producer</p>
<p>阅读教材</p>
<h5 id="model-checker"><a href="#model-checker" class="headerlink" title="model-checker"></a>model-checker</h5><p>pc-cv.py</p>
<h5 id="视频翻车"><a href="#视频翻车" class="headerlink" title="视频翻车"></a>视频翻车</h5><p>打印&lt;&gt;&lt;_和 _&gt;&lt;&gt;问题</p>
<p>把状态机画出来</p>
<p>打印&lt;:三个状态</p>
<p>同理：</p>
<h5 id="fish-c"><a href="#fish-c" class="headerlink" title="fish.c"></a>fish.c</h5><p>状态机共有6个状态：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> &#123; A = <span class="number">1</span>, B, C, D, E, F, &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">rule</span> &#123;</span><br><span class="line">  <span class="type">int</span> from, ch, to;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">rule</span> rules[] = &#123;</span><br><span class="line">  &#123; A, <span class="string">&#x27;&lt;&#x27;</span>, B &#125;,</span><br><span class="line">  &#123; B, <span class="string">&#x27;&gt;&#x27;</span>, C &#125;,</span><br><span class="line">  &#123; C, <span class="string">&#x27;&lt;&#x27;</span>, D &#125;,</span><br><span class="line">  &#123; A, <span class="string">&#x27;&gt;&#x27;</span>, E &#125;,</span><br><span class="line">  &#123; E, <span class="string">&#x27;&lt;&#x27;</span>, F &#125;,</span><br><span class="line">  &#123; F, <span class="string">&#x27;&gt;&#x27;</span>, D &#125;,</span><br><span class="line">  &#123; D, <span class="string">&#x27;_&#x27;</span>, A &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>current：现在的状态</p>
<p>quota：是否有其他在打印</p>
<h2 id="信号量"><a href="#信号量" class="headerlink" title="信号量"></a>信号量</h2><h3 id="实现生产者-消费者"><a href="#实现生产者-消费者" class="headerlink" title="实现生产者-消费者"></a>实现生产者-消费者</h3><p>代码更简洁</p>
<p>适用于一单位资源</p>
<p>条件变量足够并发编程</p>
<h2 id="哲学家吃饭问题"><a href="#哲学家吃饭问题" class="headerlink" title="哲学家吃饭问题"></a>哲学家吃饭问题</h2><h3 id="代码解析philosopher-c"><a href="#代码解析philosopher-c" class="headerlink" title="代码解析philosopher.c"></a>代码解析<a target="_blank" rel="noopener" href="http://jyywiki.cn/pages/OS/2022/demos/philosopher.c">philosopher.c</a></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">sem_t</span> locks[N]</span><br></pre></td></tr></table></figure>

<p>为每一个哲学家创建一个信号量</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lhs<span class="comment">//左手边叉子的编号</span></span><br><span class="line">rhs<span class="comment">//右手边叉子的编号</span></span><br></pre></td></tr></table></figure>

<h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><p>每个人得到一把叉子：死锁bug</p>
<p>没有线程有进展</p>
<h3 id="成功的尝试"><a href="#成功的尝试" class="headerlink" title="成功的尝试"></a>成功的尝试</h3><h5 id="条件变量（万能的方法）"><a href="#条件变量（万能的方法）" class="headerlink" title="条件变量（万能的方法）"></a>条件变量（万能的方法）</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mutex_lock(&amp;mutex);<span class="comment">//先上一把互斥锁</span></span><br><span class="line"><span class="keyword">while</span> (!(avail[lhs] &amp;&amp; avail[rhs])) &#123;</span><br><span class="line">  wait(&amp;cv, &amp;mutex);</span><br><span class="line">&#125;</span><br><span class="line">avail[lhs] = avail[rhs] = <span class="literal">false</span>;</span><br><span class="line">mutex_unlock(&amp;mutex);<span class="comment">//释放锁</span></span><br><span class="line"></span><br><span class="line">mutex_lock(&amp;mutex);</span><br><span class="line">avail[lhs] = avail[rhs] = <span class="literal">true</span>;</span><br><span class="line">broadcast(&amp;cv);</span><br><span class="line">mutex_unlock(&amp;mutex);</span><br></pre></td></tr></table></figure>

<h5 id="Leader-follower-生产者-消费者"><a href="#Leader-follower-生产者-消费者" class="headerlink" title="Leader/follower-生产者/消费者"></a>Leader/follower-生产者/消费者</h5><p>叉子在集中的管理者手上</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">Tphilosopher</span><span class="params">(<span class="type">int</span> id)</span> &#123;</span><br><span class="line">  send_request(id, EAT);<span class="comment">//吃饭请求</span></span><br><span class="line">  P(allowed[id]); <span class="comment">// waiter 会把叉子递给哲学家</span></span><br><span class="line">  philosopher_eat();</span><br><span class="line">  send_request(id, DONE);<span class="comment">//吃完的消息</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">Twaiter</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    (id, status) = receive_request();</span><br><span class="line">    <span class="keyword">if</span> (status == EAT) &#123; ... &#125;</span><br><span class="line">    <span class="keyword">if</span> (status == DONE) &#123; ... &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
















      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/23/%E9%97%AE%E6%B1%82OJ/%E7%AC%AC%E5%9B%9B%E5%AD%A6%E6%9C%9F%E7%AC%AC4%E6%AC%A1%E4%BD%9C%E4%B8%9A01/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="SUN Shiyu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="codewithssy">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/23/%E9%97%AE%E6%B1%82OJ/%E7%AC%AC%E5%9B%9B%E5%AD%A6%E6%9C%9F%E7%AC%AC4%E6%AC%A1%E4%BD%9C%E4%B8%9A01/" class="post-title-link" itemprop="url">聚会地点问题</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-03-23 23:11:00" itemprop="dateCreated datePublished" datetime="2022-03-23T23:11:00+08:00">2022-03-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-03-27 11:03:17" itemprop="dateModified" datetime="2022-03-27T11:03:17+08:00">2022-03-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%AE%97%E6%B3%95%E9%A2%98%E8%A7%A3/" itemprop="url" rel="index"><span itemprop="name">算法题解</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="聚会地点问题"><a href="#聚会地点问题" class="headerlink" title="聚会地点问题"></a>聚会地点问题</h1><p>第四学期问题求解OJ 第4次作业 第一题</p>
<h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p><a target="_blank" rel="noopener" href="https://cscamp.nju.edu.cn/contest/49/problem/2">B. 聚会地点问题 - 问题求解第四学期作业2 - 比赛 - 问题求解OJ (nju.edu.cn)</a></p>
<h2 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h2><h3 id="曼哈顿距离"><a href="#曼哈顿距离" class="headerlink" title="曼哈顿距离"></a>曼哈顿距离</h3><p>d(i,j)=|X1-X2|+|Y1-Y2|</p>
<p>横纵坐标可以分开计算</p>
<p>可以转化为一维问题，建立在中位数的位置</p>
<p>证明：</p>
<p>1 1 1 2 3 </p>
<p>1/2</p>
<p>确实是1</p>
<p>同样的还有：</p>
<p>欧几里得距离</p>
<p>切比雪夫距离：max（|x2-x1|，|y2-y1|）</p>
<h3 id="求中位数"><a href="#求中位数" class="headerlink" title="求中位数"></a>求中位数</h3><p><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/problem/solution/P1168">P1168 中位数 - 洛谷 | 计算机科学教育新生态 (luogu.com.cn)</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="type">int</span> n;</span><br><span class="line">vector&lt;<span class="type">int</span>&gt;a;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    cin&gt;&gt;n;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>,x;i&lt;=n;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>,&amp;x);</span><br><span class="line">        a.<span class="built_in">insert</span>(<span class="built_in">upper_bound</span>(a.<span class="built_in">begin</span>(),a.<span class="built_in">end</span>(),x),x);<span class="comment">//二分插入保证单调性</span></span><br><span class="line">        <span class="keyword">if</span>(i%<span class="number">2</span>==<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">        	<span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,a[(i<span class="number">-1</span>)/<span class="number">2</span>]);<span class="comment">//是奇数个就输出</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="upper-bound-函数"><a href="#upper-bound-函数" class="headerlink" title="upper_bound()函数"></a>upper_bound()函数</h5><p>用于在指定范围内查找大于目标值的第一个元素</p>
<p>语法格式：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//查找[first, last)区域中第一个大于 val 的元素。</span></span><br><span class="line"><span class="function">ForwardIterator <span class="title">upper_bound</span> <span class="params">(ForwardIterator first, ForwardIterator last, <span class="type">const</span> T&amp; val)</span></span>;</span><br><span class="line"><span class="comment">//查找[first, last)区域中第一个不符合 comp 规则的元素</span></span><br><span class="line"><span class="function">ForwardIterator <span class="title">upper_bound</span> <span class="params">(ForwardIterator first, ForwardIterator last, <span class="type">const</span> T&amp; val, Compare comp)</span></span>;</span><br></pre></td></tr></table></figure>

<h5 id="vector-容器"><a href="#vector-容器" class="headerlink" title="vector()容器"></a>vector()容器</h5><p>能够存放任意类型的动态数组</p>
<ul>
<li><code>iterator insert(iterator it,const T&amp; x)</code>:向量中迭代器指向元素前增加一个元素x</li>
<li><code>iterator begin()</code>:返回向量头指针，指向第一个元素</li>
<li><code>iterator end()</code>:返回向量尾指针，指向向量最后一个元素的下一个位置</li>
</ul>
<h5 id="向下取整"><a href="#向下取整" class="headerlink" title="向下取整"></a>向下取整</h5><p>int a/b 本身就是向下取整</p>
<h5 id="sort函数"><a href="#sort函数" class="headerlink" title="sort函数"></a>sort函数</h5><p>可以对普通数组或者容器中指定范围内的元素进行排序</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sort</span> (first,last);</span><br></pre></td></tr></table></figure>

<p>sort()只对array，vector，deque三个容器提供支持</p>
<p>对于普通数组X[n]来说,如果从X[0]开始存放数据的话，first=X;last=X+n;</p>
<h5 id="输出中位数的坐标"><a href="#输出中位数的坐标" class="headerlink" title="输出中位数的坐标"></a>输出中位数的坐标</h5><ul>
<li>从X[0]开始存的话，输出X[(n-1)/2]</li>
<li>从X[1]开始存的话<ul>
<li>先判断奇偶性<ul>
<li>(n&amp;1)(奇)， 输出X[n/2+1]</li>
<li>输出X[n/2]</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>由此看来，从0开始存比较好</p>
<h2 id="OJ结果"><a href="#OJ结果" class="headerlink" title="OJ结果"></a>OJ结果</h2><h3 id="Time-Limit-Exceeded"><a href="#Time-Limit-Exceeded" class="headerlink" title="Time Limit Exceeded"></a>Time Limit Exceeded</h3><p>可能是用vector容器导致速度过慢</p>
<p>尝试用数组解决</p>
<h3 id="WA"><a href="#WA" class="headerlink" title="WA"></a>WA</h3><p>没有注意x，y的数据范围</p>
<p>全都应该用ll</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">long</span> ll;</span><br></pre></td></tr></table></figure>

<h2 id="AC代码"><a href="#AC代码" class="headerlink" title="AC代码"></a>AC代码</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">long</span> ll;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> max 100005</span></span><br><span class="line">ll n;</span><br><span class="line">ll X[max]=&#123;<span class="number">0</span>&#125;,Y[max]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    cin&gt;&gt;n;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;n;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        ll x,y;</span><br><span class="line">        cin&gt;&gt;x&gt;&gt;y;</span><br><span class="line">        X[i]=x;Y[i]=y;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">sort</span>(X,X+n);</span><br><span class="line">    <span class="built_in">sort</span>(Y,Y+n);</span><br><span class="line">    cout&lt;&lt;X[(n<span class="number">-1</span>)/<span class="number">2</span>]&lt;&lt;<span class="string">&quot; &quot;</span>&lt;&lt;Y[(n<span class="number">-1</span>)/<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/23/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/05/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="SUN Shiyu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="codewithssy">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/23/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/05/" class="post-title-link" itemprop="url">OS05并发控制：互斥</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-03-23 20:46:00" itemprop="dateCreated datePublished" datetime="2022-03-23T20:46:00+08:00">2022-03-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-04-01 22:06:21" itemprop="dateModified" datetime="2022-04-01T22:06:21+08:00">2022-04-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">课程笔记</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="05并发控制：互斥"><a href="#05并发控制：互斥" class="headerlink" title="05并发控制：互斥"></a>05并发控制：互斥</h1><h2 id="互斥问题分析"><a href="#互斥问题分析" class="headerlink" title="互斥问题分析"></a>互斥问题分析</h2><p>Peterson算法以低效率实现互斥</p>
<p>本节课介绍两种锁的实现：</p>
<ul>
<li>自旋锁</li>
<li>互斥锁</li>
</ul>
<p>互斥</p>
<ul>
<li><p>实现lock_t数据结构</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">typedef struct &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125; lock_t;</span><br><span class="line">void lock(lock_t *lk);</span><br><span class="line">void unlock(lock_t *lk);</span><br></pre></td></tr></table></figure></li>
<li><p>lock/unlock API</p>
</li>
</ul>
<p>当其他线程持有锁时，lock无法返回，一直等待</p>
<p>实现互斥的<strong>根本困难</strong>：不能同时读写（load、store）共享内存</p>
<h3 id="perterson-barrier-c代码精读"><a href="#perterson-barrier-c代码精读" class="headerlink" title="perterson-barrier.c代码精读"></a>perterson-barrier.c代码精读</h3><p>是成功的尝试</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> BARRIER __sync_synchronize()</span></span><br></pre></td></tr></table></figure>



<h2 id="原子指令和自旋锁"><a href="#原子指令和自旋锁" class="headerlink" title="原子指令和自旋锁"></a>原子指令和自旋锁</h2><h3 id="lock指令前缀"><a href="#lock指令前缀" class="headerlink" title="lock指令前缀"></a>lock指令前缀</h3><p>内联汇编：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">asm</span> <span class="title function_">volatile</span><span class="params">(<span class="string">&quot;lock addq $1, %0&quot;</span>: <span class="string">&quot;+m&quot;</span>(sum))</span>;</span><br></pre></td></tr></table></figure>

<p>lock指令前缀：天黑请闭眼</p>
<h3 id="xchg指令实现互斥"><a href="#xchg指令实现互斥" class="headerlink" title="xchg指令实现互斥"></a>xchg指令实现互斥</h3><p>xchg本身就是原子指令：atomic exchange</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">xchg</span><span class="params">(<span class="keyword">volatile</span> <span class="type">int</span> *addr, <span class="type">int</span> newval)</span> </span>&#123;</span><br><span class="line">  <span class="type">int</span> result;</span><br><span class="line">  <span class="function"><span class="keyword">asm</span> <span class="title">volatile</span> <span class="params">(<span class="string">&quot;lock xchg %0, %1&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">    : <span class="string">&quot;+m&quot;</span>(*addr), <span class="string">&quot;=a&quot;</span>(result) : <span class="string">&quot;1&quot;</span>(newval))</span></span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="自旋锁"><a href="#自旋锁" class="headerlink" title="自旋锁"></a>自旋锁</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> table = YES;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">retry:</span><br><span class="line">  <span class="type">int</span> got = xchg(&amp;table, NOPE);</span><br><span class="line">  <span class="keyword">if</span> (got == NOPE)</span><br><span class="line">    <span class="keyword">goto</span> retry;</span><br><span class="line">  assert(got == YES);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">  xchg(&amp;table, YES)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> locked = <span class="number">0</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123; <span class="keyword">while</span> (xchg(&amp;locked, <span class="number">1</span>)) ; &#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123; xchg(&amp;locked, <span class="number">0</span>); &#125;</span><br></pre></td></tr></table></figure>

<p>两段代码是等价的，实现了自旋锁。</p>
<p>自旋体现在retry上面</p>
<h4 id="自旋锁的缺陷"><a href="#自旋锁的缺陷" class="headerlink" title="自旋锁的缺陷"></a>自旋锁的缺陷</h4><ul>
<li>争抢lock导致线程陷入死循环</li>
<li>获得自旋锁的线程会被操作系统切换出去</li>
</ul>
<h4 id="自旋锁的使用条件"><a href="#自旋锁的使用条件" class="headerlink" title="自旋锁的使用条件"></a>自旋锁的使用条件</h4><ul>
<li>几乎不出现争抢</li>
<li>持有自旋锁时禁止执行流切换</li>
</ul>
<p>通常的使用场景：操作系统内核的并发数据结构 (短临界区)</p>
<h2 id="Futex：Fast-Userspace-muTexes"><a href="#Futex：Fast-Userspace-muTexes" class="headerlink" title="Futex：Fast Userspace muTexes"></a>Futex：Fast Userspace muTexes</h2><p>可以直接调用线程库里的互斥锁mutex_lock</p>
<p>thread-sync.h 头文件中定义了：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Mutex</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">pthread_mutex_t</span> <span class="type">mutex_t</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MUTEX_INIT() PTHREAD_MUTEX_INITIALIZER</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">mutex_lock</span><span class="params">(<span class="type">mutex_t</span> *lk)</span>   </span>&#123; <span class="built_in">pthread_mutex_lock</span>(lk); &#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">mutex_unlock</span><span class="params">(<span class="type">mutex_t</span> *lk)</span> </span>&#123; <span class="built_in">pthread_mutex_unlock</span>(lk); &#125;</span><br></pre></td></tr></table></figure>

<p>将代码修改为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">mutex_t</span> lock = <span class="built_in">MUTEX_INIT</span>();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Tsum</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">    <span class="built_in">mutex_lock</span>(&amp;lock);</span><br><span class="line">    sum++;</span><br><span class="line">    <span class="built_in">mutex_unlock</span>(&amp;lock);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 即可。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/23/L1%EF%BC%9A%E7%89%A9%E7%90%86%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%EF%BC%88pmm%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="SUN Shiyu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="codewithssy">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/23/L1%EF%BC%9A%E7%89%A9%E7%90%86%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%EF%BC%88pmm%EF%BC%89/" class="post-title-link" itemprop="url">L1物理内存管理（pmm）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-03-23 17:05:00" itemprop="dateCreated datePublished" datetime="2022-03-23T17:05:00+08:00">2022-03-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-04-05 23:00:42" itemprop="dateModified" datetime="2022-04-05T23:00:42+08:00">2022-04-05</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AE%9E%E9%AA%8C%E8%AE%B0%E5%BD%95/" itemprop="url" rel="index"><span itemprop="name">实验记录</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="L1：物理内存管理（pmm）"><a href="#L1：物理内存管理（pmm）" class="headerlink" title="L1：物理内存管理（pmm）"></a>L1：物理内存管理（pmm）</h1><h2 id="框架代码"><a href="#框架代码" class="headerlink" title="框架代码"></a>框架代码</h2><ul>
<li><p>.<br>├── Makefile<br>├── framework<br>│   ├── kernel.h<br>│   └── main.c<br>├── include<br>│   └── common.h<br>└── src</p>
<pre><code>├── os.c
└── pmm.c
</code></pre>
<p>3 directories, 6 files</p>
</li>
</ul>
<h3 id="Makefile"><a href="#Makefile" class="headerlink" title="Makefile"></a>Makefile</h3><h4 id="如何阅读Makefile"><a href="#如何阅读Makefile" class="headerlink" title="如何阅读Makefile"></a>如何阅读Makefile</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">make -nB | grep -v &#x27;^mkdir&#x27; | vim -</span><br><span class="line"></span><br><span class="line">:%s/^/\r</span><br><span class="line">:%s/ /\r /g</span><br></pre></td></tr></table></figure>

<h4 id="main"><a href="#main" class="headerlink" title="main"></a>main</h4><p>调用os模块里的init和run</p>
<p>os定义在kernel.h中</p>
<h2 id="实验描述"><a href="#实验描述" class="headerlink" title="实验描述"></a>实验描述</h2><h3 id="kalloc-内存分配"><a href="#kalloc-内存分配" class="headerlink" title="kalloc 内存分配"></a>kalloc 内存分配</h3><p>阅读教材OSTEP第29、17章：</p>
<h4 id="基于锁的并发数据结构"><a href="#基于锁的并发数据结构" class="headerlink" title="基于锁的并发数据结构"></a>基于锁的并发数据结构</h4><h5 id="并发计数器"><a href="#并发计数器" class="headerlink" title="并发计数器"></a>并发计数器</h5><p>在调用函数操作该数据结构时获取锁，从调用返回时释放锁</p>
<h5 id="懒惰计数器"><a href="#懒惰计数器" class="headerlink" title="懒惰计数器"></a>懒惰计数器</h5><p>增加局部计数器，定期转移给全局计数器</p>
<h5 id="并发链表"><a href="#并发链表" class="headerlink" title="并发链表"></a>并发链表</h5><p>书上展示了一个调整的过程，第一个版本的代码存在问题：malloc失败无法释放锁</p>
<p>调整代码，让获取锁和释放锁只环绕插入代码的真正临界区  </p>
<h5 id="并发队列"><a href="#并发队列" class="headerlink" title="并发队列"></a>并发队列</h5><h5 id="并发散列表（哈希表）"><a href="#并发散列表（哈希表）" class="headerlink" title="并发散列表（哈希表）"></a>并发散列表（哈希表）</h5><h4 id="空闲空间管理"><a href="#空闲空间管理" class="headerlink" title="空闲空间管理"></a>空闲空间管理</h4><h5 id="malloc"><a href="#malloc" class="headerlink" title="malloc"></a>malloc</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> * <span class="title function_">malloc</span><span class="params">(<span class="type">size_t</span> size)</span></span><br></pre></td></tr></table></figure>

<p>传入参数：请求的字节数</p>
<p>返回指向这样大小的一块空间的指针</p>
<h5 id="free"><a href="#free" class="headerlink" title="free"></a>free</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">free</span><span class="params">(<span class="type">void</span> *ptr)</span></span><br></pre></td></tr></table></figure>

<p>释放指针对应的内存块，释放内存的大小并未告知，所以需要：</p>
<h5 id="追踪已分配空间的大小"><a href="#追踪已分配空间的大小" class="headerlink" title="追踪已分配空间的大小"></a>追踪已分配空间的大小</h5><p>给以已分配的区域加上header块</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">header_t</span>&#123;</span></span><br><span class="line">	<span class="type">int</span> size;<span class="comment">//分配空间大小</span></span><br><span class="line">	<span class="type">int</span> magic;<span class="comment">//提供完整性检查</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>获取header块的指针：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">free</span><span class="params">(<span class="type">void</span> *ptr)</span>&#123;</span><br><span class="line">	<span class="type">header_t</span> *hptr = (<span class="type">void</span> *)ptr - <span class="keyword">sizeof</span>(<span class="type">header_t</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实际释放的空间要加上header块大小</p>
<h5 id="空闲列表"><a href="#空闲列表" class="headerlink" title="空闲列表"></a>空闲列表</h5><p>记录未分配的空间</p>
<h5 id="分割与合并"><a href="#分割与合并" class="headerlink" title="分割与合并"></a>分割与合并</h5><p>请求空间小于可用的内存空间时 分割</p>
<p>调用free时执行合并操作</p>
<h3 id="kfree-内存释放"><a href="#kfree-内存释放" class="headerlink" title="kfree 内存释放"></a>kfree 内存释放</h3>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">SUN Shiyu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">23</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2022-3-21 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">SUN Shiyu</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

</body>
</html>
